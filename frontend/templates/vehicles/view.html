{% extends "base.html" %}

{% block title %}Vehicle Details - {{ app_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-header d-print-none">
            <div class="container-xl">
                <div class="row g-2 align-items-center">
                    <div class="col">
                        <div class="page-pretitle">
                            Vehicle Details
                        </div>
                        <h2 class="page-title">
                            {{ vehicle.name }}
                        </h2>
                    </div>
                    <div class="col-auto ms-auto">
                        <div class="btn-list">
                            <a href="{{ url_for('vehicles.edit_vehicle', vehicle_id=vehicle._id) }}" class="btn btn-primary d-none d-sm-inline-block">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
                                    <path d="M13.5 6.5l4 4" />
                                </svg>
                                Edit Vehicle
                            </a>
                            <a href="{{ url_for('vehicles.add_maintenance', vehicle_id=vehicle._id) }}" class="btn btn-secondary d-none d-sm-inline-block">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z" />
                                    <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                                </svg>
                                Add Maintenance
                            </a>
                            <form action="{{ url_for('vehicles.delete_vehicle', vehicle_id=vehicle._id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this vehicle?');">
                                <button type="submit" class="btn btn-danger d-none d-sm-inline-block">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M4 7l16 0" />
                                        <path d="M10 11l0 6" />
                                        <path d="M14 11l0 6" />
                                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                                    </svg>
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Vehicle Information</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Make</label>
                            <div class="form-control-plaintext">{{ vehicle.make }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Model</label>
                            <div class="form-control-plaintext">{{ vehicle.model }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Year</label>
                            <div class="form-control-plaintext">{{ vehicle.year }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Registration</label>
                            <div class="form-control-plaintext">{{ vehicle.registration }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Vehicle Type</label>
                            <div class="form-control-plaintext">{{ vehicle.type|title }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Fuel Type</label>
                            <div class="form-control-plaintext">{{ vehicle.fuel_type|title }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Tank Capacity</label>
                            <div class="form-control-plaintext">{{ vehicle.tank_capacity }} liters</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Average Mileage</label>
                            <div class="form-control-plaintext">{{ vehicle.average_mileage }} km/l</div>
                        </div>
                    </div>
                </div>
                
                <div class="hr-text">Maintenance</div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Last Service Date</label>
                            <div class="form-control-plaintext">{{ vehicle.maintenance.last_service_date|string|truncate(10, True, '') if vehicle.maintenance.last_service_date else 'N/A' }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Next Service Date</label>
                            <div class="form-control-plaintext">{{ vehicle.maintenance.next_service_date|string|truncate(10, True, '') if vehicle.maintenance.next_service_date else 'N/A' }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Last Service Mileage</label>
                            <div class="form-control-plaintext">{{ vehicle.maintenance.last_service_mileage if vehicle.maintenance.last_service_mileage else 'N/A' }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title">Current Telemetry</h3>
            </div>
            <div class="card-body">
                {% if telemetry and telemetry.records and telemetry.records|length > 0 %}
                    {% set latest = telemetry.records[0] %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Fuel Level</label>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <span class="avatar avatar-sm bg-{{ 'success' if latest.fuel_level > 25 else 'danger' }}">
                                            {{ latest.fuel_level }}%
                                        </span>
                                    </div>
                                    <div class="progress flex-grow-1">
                                        <div class="progress-bar bg-{{ 'success' if latest.fuel_level > 25 else 'danger' }}" style="width: {{ latest.fuel_level }}%" role="progressbar" aria-valuenow="{{ latest.fuel_level }}" aria-valuemin="0" aria-valuemax="100">
                                            <span class="visually-hidden">{{ latest.fuel_level }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Engine Temperature</label>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <span class="avatar avatar-sm bg-{{ 'success' if latest.engine_temp < 100 else 'danger' }}">
                                            {{ latest.engine_temp }}°C
                                        </span>
                                    </div>
                                    <div class="progress flex-grow-1">
                                        {% set temp_percent = (latest.engine_temp / 150 * 100)|int %}
                                        <div class="progress-bar bg-{{ 'success' if latest.engine_temp < 100 else 'danger' }}" style="width: {{ temp_percent }}%" role="progressbar" aria-valuenow="{{ temp_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            <span class="visually-hidden">{{ temp_percent }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Speed</label>
                                <div class="form-control-plaintext">{{ latest.speed if latest.speed else 'N/A' }} km/h</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">RPM</label>
                                <div class="form-control-plaintext">{{ latest.rpm if latest.rpm else 'N/A' }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Oil Pressure</label>
                                <div class="form-control-plaintext">{{ latest.oil_pressure if latest.oil_pressure else 'N/A' }} psi</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Battery Voltage</label>
                                <div class="form-control-plaintext">{{ latest.battery_voltage if latest.battery_voltage else 'N/A' }} V</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Last Updated</label>
                                <div class="form-control-plaintext">{{ latest.timestamp|string }}</div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="empty">
                        <div class="empty-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M8 9l4 -4l4 4" />
                                <path d="M16 15l-4 4l-4 -4" />
                                <path d="M4 6l16 0" />
                                <path d="M4 18l16 0" />
                            </svg>
                        </div>
                        <p class="empty-title">No telemetry data available</p>
                        <p class="empty-subtitle text-muted">
                            No recent telemetry data has been received for this vehicle.
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title">Maintenance History</h3>
                <div class="card-actions">
                    <a href="{{ url_for('vehicles.add_maintenance', vehicle_id=vehicle._id) }}" class="btn btn-primary">
                        Add Record
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if vehicle.maintenance and vehicle.maintenance.history and vehicle.maintenance.history|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Mileage</th>
                                    <th>Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in vehicle.maintenance.history %}
                                <tr>
                                    <td>{{ record.date|string|truncate(10, True, '') }}</td>
                                    <td>{{ record.type|title }}</td>
                                    <td>{{ record.description }}</td>
                                    <td>{{ record.mileage }}</td>
                                    <td>{{ record.cost }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty">
                        <div class="empty-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M8 9l4 -4l4 4" />
                                <path d="M16 15l-4 4l-4 -4" />
                                <path d="M4 6l16 0" />
                                <path d="M4 18l16 0" />
                            </svg>
                        </div>
                        <p class="empty-title">No maintenance records</p>
                        <p class="empty-subtitle text-muted">
                            No maintenance records have been added for this vehicle.
                        </p>
                        <div class="empty-action">
                            <a href="{{ url_for('vehicles.add_maintenance', vehicle_id=vehicle._id) }}" class="btn btn-primary">
                                Add Maintenance Record
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Vehicle Analytics</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Breakdown Probability</h4>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        {% if telemetry and telemetry.analytics and telemetry.analytics.breakdown_probability %}
                                            {% set breakdown_prob = telemetry.analytics.breakdown_probability %}
                                            {% set prob_color = 'success' %}
                                            {% if breakdown_prob > 70 %}
                                                {% set prob_color = 'danger' %}
                                            {% elif breakdown_prob > 30 %}
                                                {% set prob_color = 'warning' %}
                                            {% endif %}
                                            <span class="avatar avatar-lg bg-{{ prob_color }}">
                                                {{ breakdown_prob }}%
                                            </span>
                                        {% else %}
                                            <span class="avatar avatar-lg bg-success">
                                                N/A
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if telemetry and telemetry.analytics and telemetry.analytics.breakdown_probability %}
                                            {% set breakdown_prob = telemetry.analytics.breakdown_probability %}
                                            {% if breakdown_prob > 70 %}
                                                <div class="h3 m-0">High Risk</div>
                                                <div class="text-muted">Immediate attention needed</div>
                                            {% elif breakdown_prob > 30 %}
                                                <div class="h3 m-0">Medium Risk</div>
                                                <div class="text-muted">Schedule maintenance soon</div>
                                            {% else %}
                                                <div class="h3 m-0">Low Risk</div>
                                                <div class="text-muted">Vehicle in good condition</div>
                                            {% endif %}
                                        {% else %}
                                            <div class="h3 m-0">Unknown</div>
                                            <div class="text-muted">Insufficient data for prediction</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Route Statistics</h4>
                            </div>
                            <div class="card-body">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <span class="avatar avatar-lg bg-azure">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M18 6m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                                                <path d="M6 18m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                                                <path d="M18 6l-12 12" />
                                            </svg>
                                        </span>
                                    </div>
                                    <div>
                                        {% if telemetry and telemetry.analytics and telemetry.analytics.total_routes %}
                                            <div class="h3 m-0">{{ telemetry.analytics.total_routes }} Routes</div>
                                            <div class="text-muted">{{ telemetry.analytics.total_distance }} km traveled</div>
                                        {% else %}
                                            <div class="h3 m-0">0 Routes</div>
                                            <div class="text-muted">No routes completed with this vehicle</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if telemetry and telemetry.analytics and telemetry.analytics.risk_levels %}
                                    <div class="mt-3">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-danger me-2">High</span>
                                            <div class="progress flex-grow-1">
                                                {% set high_percent = (telemetry.analytics.risk_levels.high / telemetry.analytics.total_routes * 100)|int if telemetry.analytics.total_routes > 0 else 0 %}
                                                <div class="progress-bar bg-danger" style="width: {{ high_percent }}%" role="progressbar" aria-valuenow="{{ high_percent }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ telemetry.analytics.risk_levels.high }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-warning me-2">Medium</span>
                                            <div class="progress flex-grow-1">
                                                {% set medium_percent = (telemetry.analytics.risk_levels.medium / telemetry.analytics.total_routes * 100)|int if telemetry.analytics.total_routes > 0 else 0 %}
                                                <div class="progress-bar bg-warning" style="width: {{ medium_percent }}%" role="progressbar" aria-valuenow="{{ medium_percent }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ telemetry.analytics.risk_levels.medium }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-success me-2">Low</span>
                                            <div class="progress flex-grow-1">
                                                {% set low_percent = (telemetry.analytics.risk_levels.low / telemetry.analytics.total_routes * 100)|int if telemetry.analytics.total_routes > 0 else 0 %}
                                                <div class="progress-bar bg-success" style="width: {{ low_percent }}%" role="progressbar" aria-valuenow="{{ low_percent }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ telemetry.analytics.risk_levels.low }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Fuel Level Trend</h4>
                            </div>
                            <div class="card-body">
                                <div id="fuel-chart" style="height: 250px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Engine Temperature Trend</h4>
                            </div>
                            <div class="card-body">
                                <div id="temp-chart" style="height: 250px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title">Vehicle Location</h3>
            </div>
            <div class="card-body">
                <div id="vehicle-map" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    // Initialize map
    const map = L.map('vehicle-map').setView([20.5937, 78.9629], 5);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Add vehicle marker if telemetry data available
    {% if telemetry and telemetry.records and telemetry.records|length > 0 and telemetry.records[0].location %}
        const vehicleMarker = L.marker([
            {{ telemetry.records[0].location.lat }}, 
            {{ telemetry.records[0].location.lng }}
        ]).addTo(map).bindPopup(`
            <strong>{{ vehicle.name }}</strong><br>
            Make: {{ vehicle.make }}<br>
            Model: {{ vehicle.model }}<br>
            Status: Active<br>
            Last Updated: {{ telemetry.records[0].timestamp|string }}
        `);
        
        map.setView([{{ telemetry.records[0].location.lat }}, {{ telemetry.records[0].location.lng }}], 12);
    {% endif %}
    
    // Create fuel level chart
    {% if telemetry and telemetry.records and telemetry.records|length > 0 %}
        const fuelData = [
            {% for record in telemetry.records %}
                {% if record.fuel_level is defined %}
                {
                    x: new Date('{{ record.timestamp|string }}'),
                    y: {{ record.fuel_level }}
                },
                {% endif %}
            {% endfor %}
        ];
        
        const fuelOptions = {
            series: [{
                name: 'Fuel Level',
                data: fuelData
            }],
            chart: {
                type: 'area',
                height: 250,
                toolbar: {
                    show: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 2
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.7,
                    opacityTo: 0.3,
                    stops: [0, 90, 100]
                }
            },
            xaxis: {
                type: 'datetime'
            },
            yaxis: {
                title: {
                    text: 'Fuel Level (%)'
                },
                min: 0,
                max: 100
            },
            colors: ['#206bc4'],
            markers: {
                size: 3
            },
            tooltip: {
                x: {
                    format: 'dd MMM yyyy HH:mm'
                }
            }
        };
        
        const fuelChart = new ApexCharts(document.querySelector("#fuel-chart"), fuelOptions);
        fuelChart.render();
        
        // Create engine temperature chart
        const tempData = [
            {% for record in telemetry.records %}
                {% if record.engine_temp is defined %}
                {
                    x: new Date('{{ record.timestamp|string }}'),
                    y: {{ record.engine_temp }}
                },
                {% endif %}
            {% endfor %}
        ];
        
        const tempOptions = {
            series: [{
                name: 'Engine Temperature',
                data: tempData
            }],
            chart: {
                type: 'line',
                height: 250,
                toolbar: {
                    show: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 2
            },
            xaxis: {
                type: 'datetime'
            },
            yaxis: {
                title: {
                    text: 'Temperature (°C)'
                }
            },
            colors: ['#f44336'],
            markers: {
                size: 3
            },
            annotations: {
                yaxis: [{
                    y: 110,
                    borderColor: '#f44336',
                    label: {
                        borderColor: '#f44336',
                        style: {
                            color: '#fff',
                            background: '#f44336'
                        },
                        text: 'High Temperature'
                    }
                }]
            },
            tooltip: {
                x: {
                    format: 'dd MMM yyyy HH:mm'
                }
            }
        };
        
        const tempChart = new ApexCharts(document.querySelector("#temp-chart"), tempOptions);
        tempChart.render();
    {% endif %}
</script>
{% endblock %}